<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Laser Studio - Вход / Регистрация</title>
  <!-- Добавляем иконку -->
  <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/128/2333/2333464.png">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
      padding: 30px;
      width: 400px;
      max-width: 90%;
    }
    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #555;
    }
    input[type="email"], input[type="password"], input[type="tel"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    button {
      width: 100%;
      padding: 10px;
      background-color: #667eea;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 5px;
    }
    button:hover:not(:disabled) {
      background-color: #5a6fd8;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .btn-google {
      background-color: #DB4437;
    }
    .btn-google:hover:not(:disabled) {
      background-color: #C23325;
    }
    .btn-link {
      background: none;
      color: #667eea;
      text-decoration: underline;
      cursor: pointer;
      padding: 5px 0;
      width: auto;
      font-size: 14px;
      border: none;
    }
    .btn-link:hover:not(:disabled) {
      color: #5a6fd8;
    }
    .switch-form {
      text-align: center;
      margin-top: 15px;
    }
    .message {
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      display: none;
    }
    .message.success {
      background-color: #d4edda;
      color: #155724;
      display: block;
    }
    .message.error {
      background-color: #f8d7da;
      color: #721c24;
      display: block;
    }
    .hidden {
      display: none;
    }
    .form {
      transition: opacity 0.3s ease;
    }
    /* Стили для reCAPTCHA */
    #recaptcha-container {
        margin: 10px 0;
        display: flex;
        justify-content: center;
    }
    /* Стили для формы телефона */
    #phone-form input[type="tel"] {
        padding-left: 30px; /* Отступ для плюса */
    }
    #phone-form .country-code {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
        pointer-events: none; /* Чтобы нельзя было выделить */
    }
    #phone-form .input-with-prefix {
        position: relative;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Добро пожаловать в Laser Studio</h2>

    <!-- Сообщение -->
    <div id="message" class="message"></div>

    <!-- Форма регистрации -->
    <div id="signup-form" class="form">
      <h3>Регистрация</h3>
      <form id="signup-form-element">
        <div class="form-group">
          <label for="signup-email">Email:</label>
          <input type="email" id="signup-email" required>
        </div>
        <div class="form-group">
          <label for="signup-password">Пароль:</label>
          <input type="password" id="signup-password" required>
        </div>
        <button type="button" id="register-btn">Зарегистрироваться</button>
      </form>
      <div class="switch-form">
        <span>Уже есть аккаунт? <button type="button" class="btn-link" id="switch-to-signin">Войти</button></span>
      </div>
    </div>

    <!-- Форма входа -->
    <div id="signin-form" class="form hidden">
      <h3>Вход</h3>
      <form id="signin-form-element">
        <div class="form-group">
          <label for="signin-email">Email:</label>
          <input type="email" id="signin-email" required>
        </div>
        <div class="form-group">
          <label for="signin-password">Пароль:</label>
          <input type="password" id="signin-password">
        </div>
        <button type="button" id="login-btn">Войти</button>
        <button type="button" class="btn-link" id="magic-link-trigger-btn">Войти по ссылке (Email)</button>
        <button type="button" class="btn-google" id="google-signin-btn">Войти через Google</button>
      </form>
      <div class="switch-form">
        <span>Нет аккаунта? <button type="button" class="btn-link" id="switch-to-signup">Зарегистрироваться</button></span>
      </div>
      <div class="switch-form">
        <span><button type="button" class="btn-link" id="switch-to-forgot">Забыли пароль?</button></span>
      </div>
      <div class="switch-form">
        <span><button type="button" class="btn-link" id="switch-to-phone">Войти по телефону</button></span>
      </div>
    </div>

    <!-- Форма восстановления пароля -->
    <div id="forgot-form" class="form hidden">
      <h3>Восстановление пароля</h3>
      <form id="forgot-form-element">
        <div class="form-group">
          <label for="forgot-email">Введите ваш Email:</label>
          <input type="email" id="forgot-email" required>
        </div>
        <button type="button" id="reset-password-btn">Отправить</button>
      </form>
      <div class="switch-form">
        <span><button type="button" class="btn-link" id="back-to-signin">Назад ко входу</button></span>
      </div>
    </div>

    <!-- Форма входа по ссылке (Magic Link) -->
    <div id="magic-link-form" class="form hidden">
      <h3>Вход по ссылке</h3>
      <form id="magic-link-form-element">
        <div class="form-group">
          <label for="magic-link-email">Введите ваш Email:</label>
          <input type="email" id="magic-link-email" required>
        </div>
        <p>Мы отправим вам ссылку для входа. Проверьте почту!</p>
        <button type="button" id="send-magic-link-btn">Отправить ссылку</button>
      </form>
      <div class="switch-form">
        <span><button type="button" class="btn-link" id="back-to-signin-from-magic">Назад ко входу</button></span>
      </div>
    </div>

    <!-- Форма входа по телефону -->
    <div id="phone-form" class="form hidden">
      <h3>Вход по телефону</h3>
      <form id="phone-form-element">
        <div class="form-group input-with-prefix">
          <label for="phone-number">Номер телефона:</label>
          <span class="country-code">+</span>
          <input type="tel" id="phone-number" placeholder="7XXXXXXXXXX (например, 79991234567)" required>
        </div>
        <div id="recaptcha-container"></div> <!-- Контейнер для reCAPTCHA -->
        <button type="button" id="send-verification-code-btn">Отправить код</button>
        <div class="form-group hidden" id="verification-code-group">
          <label for="verification-code">Введите код из SMS:</label>
          <input type="text" id="verification-code" maxlength="6" required>
        </div>
        <button type="button" class="hidden" id="verify-code-btn">Подтвердить код</button>
      </form>
      <div class="switch-form">
        <span><button type="button" class="btn-link" id="back-to-signin-from-phone">Назад ко входу</button></span>
      </div>
    </div>

  </div>

  <script type="module">
    // --- Firebase Setup ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-analytics.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, sendPasswordResetEmail, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, RecaptchaVerifier, signInWithPhoneNumber, PhoneAuthProvider, signInWithCredential, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAC77MgnqA0LGykek0ffVQnXu3rqadDzzo",
      authDomain: "laser-studio-auth.firebaseapp.com",
      projectId: "laser-studio-auth",
      storageBucket: "laser-studio-auth.firebasestorage.app",
      messagingSenderId: "44076997342",
      appId: "1:44076997342:web:599e315951965d8ead804f",
      measurementId: "G-SF36P0Q05Y"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);

    // --- Translations for common Firebase errors ---
    const ERROR_TRANSLATIONS = {
        // Registration / Sign Up errors
        "auth/email-already-in-use": "Этот email уже используется другим пользователем.",
        "auth/invalid-email": "Неверный формат email.",
        "auth/weak-password": "Пароль слишком слаб. Используйте минимум 6 символов.",
        "auth/operation-not-allowed": "Регистрация по email/паролю временно отключена.",

        // Sign In errors
        "auth/user-disabled": "Этот аккаунт был отключен.",
        "auth/user-not-found": "Пользователь с таким email не найден.",
        "auth/wrong-password": "Неверный пароль.",
        "auth/too-many-requests": "Слишком много попыток входа. Пожалуйста, попробуйте позже.",

        // Password Reset errors
        "auth/invalid-email": "Неверный формат email.",
        "auth/user-not-found": "Пользователь с таким email не найден.",

        // Magic Link errors
        "auth/invalid-action-code": "Ссылка недействительна или срок её действия истёк.",
        "auth/user-disabled": "Этот аккаунт был отключен.",
        "auth/user-not-found": "Пользователь с таким email не найден.",

        // Phone Auth errors
        "auth/invalid-phone-number": "Неверный формат номера телефона.",
        "auth/missing-phone-number": "Пожалуйста, введите номер телефона.",
        "auth/quota-exceeded": "Превышена квота SMS для этого проекта.",
        "auth/captcha-check-failed": "Проверка reCAPTCHA не пройдена. Пожалуйста, попробуйте снова.",
        "auth/invalid-verification-code": "Неверный код подтверждения.",
        "auth/verification-id-mismatch": "Ошибка подтверждения. Код не соответствует запросу.",

        // General / Network errors
        "auth/network-request-failed": "Ошибка сети. Проверьте подключение к интернету.",
        "auth/popup-closed-by-user": "Всплывающее окно входа закрыто пользователем.",
        "auth/cancelled-popup-request": "Предыдущий запрос на всплывающее окно был отменён.",

        // Google Sign-In errors
        "auth/popup-blocked": "Всплывающее окно входа заблокировано. Пожалуйста, разрешите всплывающие окна для этого сайта.",
        "auth/account-exists-with-different-credential": "Аккаунт с этим email уже существует, но с другим методом входа.",
        "auth/auth-domain-config-required": "Ошибка конфигурации домена. Обратитесь к администратору.",
        "auth/operation-not-supported-in-this-environment": "Эта операция не поддерживается в данной среде.",
        "auth/unauthorized-domain": "Домен не авторизован. Обратитесь к администратору.",
        // Default fallback if no translation found
        "default": "Произошла ошибка. Пожалуйста, попробуйте позже."
    };

    // Function to translate error codes
    function translateError(errorCode) {
        const code = typeof errorCode === 'string' ? errorCode : errorCode?.code;
        return ERROR_TRANSLATIONS[code] || ERROR_TRANSLATIONS['default'];
    }

    // --- UI Helper Functions ---
    let loadingButton = null;
    let recaptchaVerifier = null;
    let confirmationResult = null;

    function showMessage(message, isError = false) {
      const element = document.getElementById('message');
      element.textContent = message;
      element.className = 'message ' + (isError ? 'error' : 'success');
      element.style.display = 'block';
    }

    function hideMessage() {
        document.getElementById('message').style.display = 'none';
    }

    function disableButton(btn) {
        if (loadingButton) loadingButton.disabled = false;
        btn.disabled = true;
        loadingButton = btn;
    }

    function enableButton() {
        if (loadingButton) {
            loadingButton.disabled = false;
            loadingButton = null;
        }
    }

    // Функция показа формы - теперь доступна внутри модуля
    function showForm(formName) {
      // Скрыть все формы
      document.querySelectorAll('.form').forEach(form => form.classList.add('hidden'));
      // Показать нужную
      document.getElementById(`${formName}-form`).classList.remove('hidden');
      // Скрыть сообщение при смене формы
      hideMessage();
    }

    // --- Обработчики событий ---
    document.addEventListener('DOMContentLoaded', () => {

        // --- КНОПКИ ПЕРЕКЛЮЧЕНИЯ ФОРМ ---
        document.getElementById('switch-to-signin').addEventListener('click', () => showForm('signin'));
        document.getElementById('switch-to-signup').addEventListener('click', () => showForm('signup'));
        document.getElementById('switch-to-forgot').addEventListener('click', () => showForm('forgot'));
        document.getElementById('back-to-signin').addEventListener('click', () => showForm('signin'));
        document.getElementById('back-to-signin-from-magic').addEventListener('click', () => showForm('signin'));
        document.getElementById('magic-link-trigger-btn').addEventListener('click', () => showForm('magic-link'));
        document.getElementById('switch-to-phone').addEventListener('click', () => showForm('phone'));
        document.getElementById('back-to-signin-from-phone').addEventListener('click', () => showForm('signin'));

        // --- КНОПКИ АУТЕНТИФИКАЦИИ ---
        // Регистрация
        document.getElementById('register-btn').addEventListener('click', async () => {
            const btn = event.target;
            disableButton(btn);
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            if (!email || !password) {
                showMessage("Пожалуйста, заполните все поля.", true);
                enableButton();
                return;
            }

            try {
              const userCredential = await createUserWithEmailAndPassword(auth, email, password);
              console.log("Пользователь зарегистрирован:", userCredential.user);
              showMessage("Успешно зарегистрирован! Теперь войдите.", false);
              showForm('signin');
            } catch (error) {
              console.error("Ошибка регистрации:", error);
              showMessage(translateError(error), true);
            } finally {
                enableButton();
            }
        });

        // Вход
        document.getElementById('login-btn').addEventListener('click', async () => {
            const btn = event.target;
            disableButton(btn);
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;

            if (!email || !password) {
                showMessage("Пожалуйста, заполните все поля.", true);
                enableButton();
                return;
            }

            try {
              const userCredential = await signInWithEmailAndPassword(auth, email, password);
              console.log("Вход выполнен:", userCredential.user);
              showMessage("Успешный вход! Перенаправление...", false);
              window.location.href = '/'; // <--- РАСКОММЕНТИРОВАНО
            } catch (error) {
              console.error("Ошибка входа:", error);
              showMessage(translateError(error), true);
            } finally {
                enableButton();
            }
        });

        // Вход через Google
        document.getElementById('google-signin-btn').addEventListener('click', async () => {
            const btn = event.target;
            disableButton(btn);
            const provider = new GoogleAuthProvider();
            try {
              const result = await signInWithPopup(auth, provider);
              const user = result.user;
              console.log("Вход через Google выполнен:", user);
              showMessage("Вход через Google успешен!", false);
              window.location.href = '/'; // <--- РАСКОММЕНТИРОВАНО
            } catch (error) {
              console.error("Ошибка входа через Google:", error);
              showMessage(translateError(error), true);
            } finally {
                enableButton();
            }
        });

        // Восстановление пароля
        document.getElementById('reset-password-btn').addEventListener('click', async () => {
            const btn = event.target;
            disableButton(btn);
            const email = document.getElementById('forgot-email').value;

            if (!email) {
                showMessage("Пожалуйста, введите email.", true);
                enableButton();
                return;
            }

            try {
              await sendPasswordResetEmail(auth, email);
              showMessage("Ссылка для восстановления отправлена на " + email, false);
              setTimeout(() => showForm('signin'), 3000);
            } catch (error) {
              console.error("Ошибка восстановления пароля:", error);
              showMessage(translateError(error), true);
            } finally {
                enableButton();
            }
        });

        // Отправка Magic Link
        document.getElementById('send-magic-link-btn').addEventListener('click', async () => {
            const btn = event.target;
            disableButton(btn);
            const emailInput = document.getElementById('magic-link-email');
            const email = emailInput.value || document.getElementById('signin-email').value;

            if (!email) {
                 showMessage("Пожалуйста, введите email.", true);
                 enableButton();
                 return;
            }

            const actionCodeSettings = {
                url: `${window.location.origin}${window.location.pathname}`,
                handleCodeInApp: true,
            };

            try {
                await sendSignInLinkToEmail(auth, email, actionCodeSettings);
                window.localStorage.setItem('emailForSignIn', email);
                showMessage("Ссылка для входа отправлена на " + email + ". Проверьте почту!", false);
                setTimeout(() => showForm('signin'), 3000);
            } catch (error) {
                console.error("Ошибка отправки ссылки:", error);
                 showMessage(translateError(error), true);
            } finally {
                enableButton();
            }
        });

        // --- ТЕЛЕФОННАЯ АУТЕНТИФИКАЦИЯ ---
        // Инициализация reCAPTCHA verifier
        function initializeRecaptcha() {
            // Уничтожаем предыдущий верификатор, если он существует
            if (recaptchaVerifier) {
                recaptchaVerifier.clear();
            }
            // Создаём новый верификатор
            recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                'size': 'normal', // 'invisible' или 'normal'
                'callback': (response) => {
                    console.log('reCAPTCHA решена');
                    // Скрыть сообщение об ошибке reCAPTCHA, если было
                    hideMessage();
                },
                'expired-callback': () => {
                    console.log('Срок действия reCAPTCHA истёк');
                    showMessage('Срок действия reCAPTCHA истёк. Пожалуйста, пройдите проверку снова.', true);
                    // Очистить результат подтверждения
                    confirmationResult = null;
                }
            });
        }

        // Отправка кода подтверждения
        document.getElementById('send-verification-code-btn').addEventListener('click', async () => {
            const btn = event.target;
            disableButton(btn);
            const phoneNumber = document.getElementById('phone-number').value.trim();

            if (!phoneNumber) {
                showMessage("Пожалуйста, введите номер телефона.", true);
                enableButton();
                return;
            }

            // Проверяем формат номера (простая проверка, можно улучшить)
            if (!/^\+?\d{10,15}$/.test(phoneNumber.replace(/\s/g, ''))) {
                showMessage("Пожалуйста, введите корректный номер телефона (например, +79991234567).", true);
                enableButton();
                return;
            }

            // Убедимся, что номер начинается с +
            let formattedPhoneNumber = phoneNumber;
            if (!formattedPhoneNumber.startsWith('+')) {
                formattedPhoneNumber = '+' + formattedPhoneNumber;
            }

            try {
                // Инициализируем reCAPTCHA перед вызовом signInWithPhoneNumber
                initializeRecaptcha();

                const result = await signInWithPhoneNumber(auth, formattedPhoneNumber, recaptchaVerifier);
                console.log("SMS отправлено. Подтверждение:", result);
                confirmationResult = result; // Сохраняем результат

                // Показываем поля для ввода кода
                document.getElementById('verification-code-group').classList.remove('hidden');
                document.getElementById('verify-code-btn').classList.remove('hidden');

                showMessage("Код подтверждения отправлен на " + formattedPhoneNumber, false);

            } catch (error) {
                console.error("Ошибка отправки SMS:", error);
                showMessage(translateError(error), true);
                // Сбросить reCAPTCHA в случае ошибки
                if (recaptchaVerifier) {
                    recaptchaVerifier.render().then(function(widgetId) {
                        grecaptcha.reset(widgetId);
                    });
                }
            } finally {
                enableButton();
            }
        });

        // Подтверждение кода
        document.getElementById('verify-code-btn').addEventListener('click', async () => {
            const btn = event.target;
            disableButton(btn);
            const code = document.getElementById('verification-code').value.trim();

            if (!code) {
                showMessage("Пожалуйста, введите код подтверждения.", true);
                enableButton();
                return;
            }

            if (!confirmationResult) {
                showMessage("Сначала запросите код подтверждения.", true);
                enableButton();
                return;
            }

            try {
                const result = await confirmationResult.confirm(code);
                const user = result.user;
                console.log("Вход по телефону успешен:", user);
                showMessage("Вход по телефону успешен!", false);
                window.location.href = '/'; // <--- РАСКОММЕНТИРОВАНО
            } catch (error) {
                console.error("Ошибка подтверждения кода:", error);
                showMessage(translateError(error), true);
            } finally {
                enableButton();
            }
        });

        // --- Проверка входа по ссылке ---
        function checkForSignInLink() {
            if (isSignInWithEmailLink(auth, window.location.href)) {
                let email = window.localStorage.getItem('emailForSignIn');
                if (!email) {
                    email = window.prompt('Пожалуйста, введите ваш email для подтверждения:');
                }
                if (!email) {
                     showMessage("Не удалось получить email для подтверждения.", true);
                     return;
                }

                signInWithEmailLink(auth, email, window.location.href)
                    .then((result) => {
                        console.log("Вход по ссылке успешен:", result.user);
                        window.localStorage.removeItem('emailForSignIn');
                        showMessage("Вход по ссылке успешен!", false);
                        window.location.href = '/'; // <--- РАСКОММЕНТИРОВАНО
                    })
                    .catch((error) => {
                        console.error("Ошибка входа по ссылке:", error);
                        showMessage(translateError(error), true);
                    });
            }
        }

        checkForSignInLink();
    }); // END DOMContentLoaded

  </script>
</body>
</html>