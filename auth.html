<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Laser Studio - Вход / Регистрация</title>
  <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/128/2333/2333464.png">
  <script src="https://www.google.com/recaptcha/enterprise.js?render=6LeI-jQsAAAAAJGW7crd5rWHl57GwH6-byr1c10e"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
      padding: 30px;
      width: 400px;
      max-width: 90%;
    }
    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #555;
    }
    input[type="email"], input[type="password"], input[type="tel"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    button {
      width: 100%;
      padding: 10px;
      background-color: #667eea;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 5px;
    }
    button:hover:not(:disabled) {
      background-color: #5a6fd8;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .btn-google {
      background-color: #DB4437;
    }
    .btn-google:hover:not(:disabled) {
      background-color: #C23325;
    }
    .btn-link {
      background: none;
      color: #667eea;
      text-decoration: underline;
      cursor: pointer;
      padding: 5px 0;
      width: auto;
      font-size: 14px;
      border: none;
    }
    .btn-link:hover:not(:disabled) {
      color: #5a6fd8;
    }
    .switch-form {
      text-align: center;
      margin-top: 15px;
    }
    .message {
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      display: none;
    }
    .message.success {
      background-color: #d4edda;
      color: #155724;
      display: block;
    }
    .message.error {
      background-color: #f8d7da;
      color: #721c24;
      display: block;
    }
    .hidden {
      display: none;
    }
    .form {
      transition: opacity 0.3s ease;
    }
    /* Стили для reCAPTCHA */
    #recaptcha-container {
        margin: 10px 0;
        display: flex;
        justify-content: center;
    }
    /* Стили для формы телефона */
    #phone-form input[type="tel"] {
        padding-left: 30px; /* Отступ для плюса */
    }
    #phone-form .country-code {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
        pointer-events: none; /* Чтобы нельзя было выделить */
    }
    #phone-form .input-with-prefix {
        position: relative;
    }
    /* Стиль для кнопки админ-панели */
    .admin-btn {
        background: #f39c12;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        margin-top: 10px;
    }
    .admin-btn:hover {
        background: #e67e22;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Добро пожаловать в Laser Studio</h2>

    <!-- Сообщение -->
    <div id="message" class="message"></div>

    <!-- Кнопка админ-панели (изначально скрыта) -->
    <div id="admin-panel-link" class="switch-form hidden">
        <button type="button" class="btn-link" onclick="window.location.href='/laserinstalladmin.html'">Админ-панель</button>
    </div>

    <!-- Форма регистрации -->
    <div id="signup-form" class="form">
      <h3>Регистрация</h3>
      <form id="signup-form-element">
        <div class="form-group">
          <label for="signup-email">Email:</label>
          <input type="email" id="signup-email" required>
        </div>
        <div class="form-group">
          <label for="signup-password">Пароль:</label>
          <input type="password" id="signup-password" required>
        </div>
        <button type="button" id="register-btn">Зарегистрироваться</button>
      </form>
      <div class="switch-form">
        <span>Уже есть аккаунт? <button type="button" class="btn-link" id="switch-to-signin">Войти</button></span>
      </div>
    </div>

    <!-- Форма входа -->
    <div id="signin-form" class="form hidden">
      <h3>Вход</h3>
      <form id="signin-form-element">
        <div class="form-group">
          <label for="signin-email">Email:</label>
          <input type="email" id="signin-email" required>
        </div>
        <div class="form-group">
          <label for="signin-password">Пароль:</label>
          <input type="password" id="signin-password">
        </div>
        <button type="button" id="login-btn">Войти</button>
        <button type="button" class="btn-link" id="magic-link-trigger-btn">Войти по ссылке (Email)</button>
        <button type="button" class="btn-google" id="google-signin-btn">Войти через Google</button>
      </form>
      <div class="switch-form">
        <span>Нет аккаунта? <button type="button" class="btn-link" id="switch-to-signup">Зарегистрироваться</button></span>
      </div>
      <div class="switch-form">
        <span><button type="button" class="btn-link" id="switch-to-forgot">Забыли пароль?</button></span>
      </div>
      <div class="switch-form">
        <span><button type="button" class="btn-link" id="switch-to-phone">Войти по телефону</button></span>
      </div>
    </div>

    <!-- Форма восстановления пароля -->
    <div id="forgot-form" class="form hidden">
      <h3>Восстановление пароля</h3>
      <form id="forgot-form-element">
        <div class="form-group">
          <label for="forgot-email">Введите ваш Email:</label>
          <input type="email" id="forgot-email" required>
        </div>
        <button type="button" id="reset-password-btn">Отправить</button>
      </form>
      <div class="switch-form">
        <span><button type="button" class="btn-link" id="back-to-signin">Назад ко входу</button></span>
      </div>
    </div>

    <!-- Форма входа по ссылке (Magic Link) -->
    <div id="magic-link-form" class="form hidden">
      <h3>Вход по ссылке</h3>
      <form id="magic-link-form-element">
        <div class="form-group">
          <label for="magic-link-email">Введите ваш Email:</label>
          <input type="email" id="magic-link-email" required>
        </div>
        <p>Мы отправим вам ссылку для входа. Проверьте почту!</p>
        <button type="button" id="send-magic-link-btn">Отправить ссылку</button>
      </form>
      <div class="switch-form">
        <span><button type="button" class="btn-link" id="back-to-signin-from-magic">Назад ко входу</button></span>
      </div>
    </div>

    <!-- Форма входа по телефону -->
    <div id="phone-form" class="form hidden">
      <h3>Вход по телефону</h3>
      <form id="phone-form-element">
        <div class="form-group input-with-prefix">
          <label for="phone-number">Номер телефона:</label>
          <span class="country-code">+</span>
          <input type="tel" id="phone-number" placeholder="7XXXXXXXXXX (например, 79991234567)" required>
        </div>
        <div id="recaptcha-container"></div> <!-- Контейнер для reCAPTCHA -->
        <button type="button" id="send-verification-code-btn">Отправить код</button>
        <div class="form-group hidden" id="verification-code-group">
          <label for="verification-code">Введите код из SMS:</label>
          <input type="text" id="verification-code" maxlength="6" required>
        </div>
        <button type="button" class="hidden" id="verify-code-btn">Подтвердить код</button>
      </form>
      <div class="switch-form">
        <span><button type="button" class="btn-link" id="back-to-signin-from-phone">Назад ко входу</button></span>
      </div>
    </div>

  </div>

  <script type="module">
    // --- Firebase Setup ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-analytics.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, sendPasswordResetEmail, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, RecaptchaVerifier, signInWithPhoneNumber, PhoneAuthProvider, signInWithCredential, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAC77MgnqA0LGykek0ffVQnXu3rqadDzzo",
      authDomain: "laser-studio-auth.firebaseapp.com",
      projectId: "laser-studio-auth",
      storageBucket: "laser-studio-auth.firebasestorage.app",
      messagingSenderId: "44076997342",
      appId: "1:44076997342:web:599e315951965d8ead804f",
      measurementId: "G-SF36P0Q05Y"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);

    // --- Translations for common Firebase errors ---
    const ERROR_TRANSLATIONS = {
        // Registration / Sign Up errors
        "auth/email-already-in-use": "Этот email уже используется другим пользователем.",
        "auth/invalid-email": "Неверный формат email.",
        "auth/weak-password": "Пароль слишком слаб. Используйте минимум 6 символов.",
        "auth/operation-not-allowed": "Регистрация по email/паролю временно отключена.",

        // Sign In errors
        "auth/user-disabled": "Этот аккаунт был отключен.",
        "auth/user-not-found": "Пользователь с таким email не найден.",
        "auth/wrong-password": "Неверный пароль.",
        "auth/too-many-requests": "Слишком много попыток входа. Пожалуйста, попробуйте позже.",

        // Password Reset errors
        "auth/invalid-email": "Неверный формат email.",
        "auth/user-not-found": "Пользователь с таким email не найден.",

        // Magic Link errors
        "auth/invalid-action-code": "Ссылка недействительна или срок её действия истёк.",
        "auth/user-disabled": "Этот аккаунт был отключен.",
        "auth/user-not-found": "Пользователь с таким email не найден.",

        // Phone Auth errors
        "auth/invalid-phone-number": "Неверный формат номера телефона.",
        "auth/missing-phone-number": "Пожалуйста, введите номер телефона.",
        "auth/quota-exceeded": "Превышена квота SMS для этого проекта.",
        "auth/captcha-check-failed": "Проверка reCAPTCHA не пройдена. Пожалуйста, попробуйте снова.",
        "auth/invalid-verification-code": "Неверный код подтверждения.",
        "auth/verification-id-mismatch": "Ошибка подтверждения. Код не соответствует запросу.",

        // General / Network errors
        "auth/network-request-failed": "Ошибка сети. Проверьте подключение к интернету.",
        "auth/popup-closed-by-user": "Всплывающее окно входа закрыто пользователем.",
        "auth/cancelled-popup-request": "Предыдущий запрос на всплывающее окно был отменён.",

        // Google Sign-In errors
        "auth/popup-blocked": "Всплывающее окно входа заблокировано. Пожалуйста, разрешите всплывающие окна для этого сайта.",
        "auth/account-exists-with-different-credential": "Аккаунт с этим email уже существует, но с другим методом входа.",
        "auth/auth-domain-config-required": "Ошибка конфигурации домена. Обратитесь к администратору.",
        "auth/operation-not-supported-in-this-environment": "Эта операция не поддерживается в данной среде.",
        "auth/unauthorized-domain": "Домен не авторизован. Обратитесь к администратору.",
        // Default fallback if no translation found
        "default": "Произошла ошибка. Пожалуйста, попробуйте позже."
    };

    // Function to translate error codes
    function translateError(errorCode) {
        const code = typeof errorCode === 'string' ? errorCode : errorCode?.code;
        return ERROR_TRANSLATIONS[code] || ERROR_TRANSLATIONS['default'];
    }

    // --- UI Helper Functions ---
    let loadingButton = null;
    let recaptchaVerifier = null;
    let confirmationResult = null;

    function showMessage(message, isError = false) {
      const element = document.getElementById('message');
      element.textContent = message;
      element.className = 'message ' + (isError ? 'error' : 'success');
      element.style.display = 'block';
    }

    function hideMessage() {
        document.getElementById('message').style.display = 'none';
    }

    function disableButton(btn) {
        if (loadingButton) loadingButton.disabled = false;
        btn.disabled = true;
        loadingButton = btn;
    }

    function enableButton() {
        if (loadingButton) {
            loadingButton.disabled = false;
            loadingButton = null;
        }
    }

    // Функция показа формы - теперь доступна внутри модуля
    function showForm(formName) {
      // Скрыть все формы
      document.querySelectorAll('.form').forEach(form => form.classList.add('hidden'));
      // Показать нужную
      document.getElementById(`${formName}-form`).classList.remove('hidden');
      // Скрыть сообщение при смене формы
      hideMessage();
    }

    // --- Проверка авторизации и отображение админ-панели ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("Пользователь вошёл:", user);
            // Проверяем, является ли пользователь администратором
            if (user.email === 'teevich@mail.ru') {
                document.getElementById('admin-panel-link').classList.remove('hidden');
            }
        } else {
            console.log("Пользователь не вошёл.");
        }
    });

    // --- Обработчики событий ---
    document.addEventListener('DOMContentLoaded', () => {

        // --- КНОПКИ ПЕРЕКЛЮЧЕНИЯ ФОРМ ---
        document.getElementById('switch-to-signin').addEventListener('click', () => showForm('signin'));
        document.getElementById('switch-to-signup').addEventListener('click', () => showForm('signup'));
        document.getElementById('switch-to-forgot').addEventListener('click', () => showForm('forgot'));
        document.getElementById('back-to-signin').addEventListener('click', () => showForm('signin'));
        document.getElementById('back-to-signin-from-magic').addEventListener('click', () => showForm('signin'));
        document.getElementById('magic-link-trigger-btn').addEventListener('click', () => showForm('magic-link'));
        document.getElementById('switch-to-phone').addEventListener('click', () => showForm('phone'));
        document.getElementById('back-to-signin-from-phone').addEventListener('click', () => showForm('signin'));

        // --- КНОПКИ АУТЕНТИФИКАЦИИ ---
        // Регистрация
        document.getElementById('register-btn').addEventListener('click', async () => {
            const btn = event.target;
            disableButton(btn);
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            if (!email || !password) {
                showMessage("Пожалуйста, заполните все поля.", true);
                enableButton();
                return;
            }

            // Вызов reCAPTCHA для регистрации
            try {
              grecaptcha.enterprise.ready(async () => {
                const token = await grecaptcha.enterprise.execute('6LeI-jQsAAAAAJGW7crd5rWHl57GwH6-byr1c10e', {action: 'REGISTER'});
                
                // Здесь можно отправить токен на сервер для проверки
                // Пока пропускаем проверку и регистрируем пользователя
                try {
                  const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                  console.log("Пользователь зарегистрирован:", userCredential.user);
                  showMessage("Успешно зарегистрирован! Теперь войдите.", false);
                  showForm('signin');
                } catch (error) {
                  console.error("Ошибка регистрации:", error);
                  showMessage(translateError(error), true);
                } finally {
                    enableButton();
                }
              });
            } catch (error) {
              console.error("Ошибка reCAPTCHA:", error);
              showMessage("Ошибка проверки безопасности. Пожалуйста, попробуйте позже.", true);
              enableButton();
            }
        });

        // Вход
        document.getElementById('login-btn').addEventListener('click', async () => {
            const btn = event.target;
            disableButton(btn);
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;

            if (!email || !password) {
                showMessage("Пожалуйста, заполните все поля.", true);
                enableButton();
                return;
            }

            // Вызов reCAPTCHA для входа
            try {
              grecaptcha.enterprise.ready(async () => {
                const token = await grecaptcha.enterprise.execute('6LeI-jQsAAAAAJGW7crd5rWHl57GwH6-byr1c10e', {action: 'LOGIN'});
                
                // Здесь можно отправить токен на сервер для проверки
                // Пока пропускаем проверку и выполняем вход
                try {
                  const userCredential = await signInWithEmailAndPassword(auth, email, password);
                  console.log("Вход выполнен:", userCredential.user);
                  showMessage("Успешный вход! Перенаправление...", false);
                  window.location.href = '/'; // <--- РАСКОММЕНТИРОВАНО
                } catch (error) {
                  console.error("Ошибка входа:", error);
                  showMessage(translateError(error), true);
                } finally {
                    enableButton();
                }
              });
            } catch (error) {
              console.error("Ошибка reCAPTCHA:", error);
              showMessage("Ошибка проверки безопасности. Пожалуйста, попробуйте позже.", true);
              enableButton();
            }
        });

        // Вход через Google
        document.getElementById('google-signin-btn').addEventListener('click', async () => {
            const btn = event.target;
            disableButton(btn);
            const provider = new GoogleAuthProvider();
            
            // Вызов reCAPTCHA для Google входа
            try {
              grecaptcha.enterprise.ready(async () => {
                const token = await grecaptcha.enterprise.execute('6LeI-jQsAAAAAJGW7crd5rWHl57GwH6-byr1c10e', {action: 'GOOGLE_LOGIN'});
                
                // Здесь можно отправить токен на сервер для проверки
                // Пока пропускаем проверку и выполняем вход через Google
                try {
                  const result = await signInWithPopup(auth, provider);
                  const user = result.user;
                  console.log("Вход через Google выполнен:", user);
                  showMessage("Вход через Google успешен!", false);
                  window.location.href = '/'; // <--- РАСКОММЕНТИРОВАНО
                } catch (error) {
                  console.error("Ошибка входа через Google:", error);
                  showMessage(translateError(error), true);
                } finally {
                    enableButton();
                }
              });
            } catch (error) {
              console.error("Ошибка reCAPTCHA:", error);
              showMessage("Ошибка проверки безопасности. Пожалуйста, попробуйте позже.", true);
              enableButton();
            }
        });

        // Восстановление пароля
        document.getElementById('reset-password-btn').addEventListener('click', async () => {
            const btn = event.target;
            disableButton(btn);
            const email = document.getElementById('forgot-email').value;

            if (!email) {
                showMessage("Пожалуйста, введите email.", true);
                enableButton();
                return;
            }

            // Вызов reCAPTCHA для восстановления пароля
            try {
              grecaptcha.enterprise.ready(async () => {
                const token = await grecaptcha.enterprise.execute('6LeI-jQsAAAAAJGW7crd5rWHl57GwH6-byr1c10e', {action: 'PASSWORD_RESET'});
                
                // Здесь можно отправить токен на сервер для проверки
                // Пока пропускаем проверку и отправляем письмо
                try {
                  await sendPasswordResetEmail(auth, email);
                  showMessage("Ссылка для восстановления отправлена на " + email, false);
                  setTimeout(() => showForm('signin'), 3000);
                } catch (error) {
                  console.error("Ошибка восстановления пароля:", error);
                  showMessage(translateError(error), true);
                } finally {
                    enableButton();
                }
              });
            } catch (error) {
              console.error("Ошибка reCAPTCHA:", error);
              showMessage("Ошибка проверки безопасности. Пожалуйста, попробуйте позже.", true);
              enableButton();
            }
        });

        // Отправка Magic Link
        document.getElementById('send-magic-link-btn').addEventListener('click', async () => {
            const btn = event.target;
            disableButton(btn);
            const emailInput = document.getElementById('magic-link-email');
            const email = emailInput.value || document.getElementById('signin-email').value;

            if (!email) {
                 showMessage("Пожалуйста, введите email.", true);
                 enableButton();
                 return;
            }

            // Вызов reCAPTCHA для отправки magic link
            try {
              grecaptcha.enterprise.ready(async () => {
                const token = await grecaptcha.enterprise.execute('6LeI-jQsAAAAAJGW7crd5rWHl57GwH6-byr1c10e', {action: 'MAGIC_LINK'});
                
                // Здесь можно отправить токен на сервер для проверки
                // Пока пропускаем проверку и отправляем ссылку
                try {
                  await sendSignInLinkToEmail(auth, email, {
                    url: window.location.href,
                    handleCodeInApp: true
                  });
                  localStorage.setItem('emailForSignIn', email);
                  showMessage("Ссылка для входа отправлена на " + email, false);
                  setTimeout(() => showForm('signin'), 3000);
                } catch (error) {
                  console.error("Ошибка отправки magic link:", error);
                  showMessage(translateError(error), true);
                } finally {
                    enableButton();
                }
              });
            } catch (error) {
              console.error("Ошибка reCAPTCHA:", error);
              showMessage("Ошибка проверки безопасности. Пожалуйста, попробуйте позже.", true);
              enableButton();
            }
        });

        // Инициализация reCAPTCHA для формы телефона
        window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
          'size': 'normal',
          'callback': (response) => {
            // reCAPTCHA решена, теперь можно отправить SMS
            console.log('reCAPTCHA решена');
          },
          'expired-callback': () => {
            // reCAPTCHA истекла
            console.log('reCAPTCHA истекла');
          }
        });
        
        // Отправка кода подтверждения по телефону
        document.getElementById('send-verification-code-btn').addEventListener('click', async () => {
            const btn = event.target;
            disableButton(btn);
            const phoneNumber = document.getElementById('phone-number').value;

            if (!phoneNumber) {
                showMessage("Пожалуйста, введите номер телефона.", true);
                enableButton();
                return;
            }

            try {
              const appVerifier = window.recaptchaVerifier;
              confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
              console.log("Код отправлен на телефон:", phoneNumber);
              document.getElementById('verification-code-group').classList.remove('hidden');
              document.getElementById('verify-code-btn').classList.remove('hidden');
              showMessage("Код отправлен на телефон. Пожалуйста, проверьте SMS.", false);
            } catch (error) {
              console.error("Ошибка отправки SMS:", error);
              showMessage(translateError(error), true);
            } finally {
                enableButton();
            }
        });

        // Подтверждение кода из SMS
        document.getElementById('verify-code-btn').addEventListener('click', async () => {
            const btn = event.target;
            disableButton(btn);
            const code = document.getElementById('verification-code').value;

            if (!code) {
                showMessage("Пожалуйста, введите код из SMS.", true);
                enableButton();
                return;
            }

            try {
              const result = await confirmationResult.confirm(code);
              console.log("Вход по телефону выполнен:", result.user);
              showMessage("Успешный вход по телефону!", false);
              window.location.href = '/';
            } catch (error) {
              console.error("Ошибка подтверждения кода:", error);
              showMessage(translateError(error), true);
            } finally {
                enableButton();
            }
        });
    });

    // Проверка, является ли пользователь уже вошедшим по magic link
    window.addEventListener('load', async () => {
      const auth = getAuth();
      const email = localStorage.getItem('emailForSignIn');
      
      if (email && isSignInWithEmailLink(auth, window.location.href)) {
        try {
          const result = await signInWithEmailLink(auth, email, window.location.href);
          localStorage.removeItem('emailForSignIn');
          showMessage("Успешный вход по ссылке! Перенаправление...", false);
          window.location.href = '/';
        } catch (error) {
          console.error("Ошибка входа по magic link:", error);
          showMessage(translateError(error), true);
        }
      }
    });
  </script>
</body>
</html>
