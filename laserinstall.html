<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Laser Install - Загрузки</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/128/2333/2333464.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        header {
            background: linear-gradient(135deg, #007BFF 0%, #0056b3 100%);
            color: white;
            padding: 30px 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        nav {
            background: #2c3e50;
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        nav ul {
            list-style: none;
            display: flex;
            justify-content: center;
            gap: 30px;
        }
        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        nav a:hover {
            color: #3498db;
        }
        .main-content {
            padding: 40px 0;
        }
        .sidebar {
            width: 200px;
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            height: fit-content;
        }
        .sidebar ul {
            list-style: none;
        }
        .sidebar li {
            margin-bottom: 10px;
        }
        .sidebar a {
            text-decoration: none;
            color: #2c3e50;
            font-weight: 500;
            padding: 5px 10px;
            display: block;
            border-radius: 5px;
            transition: background 0.3s;
        }
        .sidebar a:hover, .sidebar a.active {
            background: #3498db;
            color: white;
        }
        .content-area {
            flex: 1;
            padding-left: 30px;
        }
        .category-section {
            display: none; /* Сначала все категории скрыты */
        }
        .category-section.active {
            display: block; /* Показывается активная категория */
        }
        .item-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .item-info h3 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .item-info p {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        .download-btn {
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            transition: background 0.3s;
        }
        .download-btn:hover {
            background: #219653;
        }
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 15px;
        }
        .logout-btn:hover {
            background: #c0392b;
        }
        .admin-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 15px;
        }
        .admin-btn:hover {
            background: #e67e22;
        }
        .layout {
            display: flex;
            gap: 20px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        @media (max-width: 768px) {
            .layout {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
            }
            .content-area {
                padding-left: 0;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Laser Install</h1>
            <p>Скачивайте программы и игры от Laser Studio</p>
            <div id="auth-status" style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;"></div>
        </div>
    </header>

    <nav>
        <div class="container">
            <ul>
                <li><a href="index.html">Главная</a></li>
                <li><a href="laserinstall.html">Установка</a></li>
                <li><a href="about.html">О компании</a></li>
                <li><a href="support.html">Поддержка</a></li>
                <li><a href="payment.html">Оплата</a></li>
                <li><a href="faq.html">FAQ</a></li>
                <li><a href="games.html">Наши игры</a></li>
                <li><a href="news.html">Новости</a></li>
                <li><a href="social.html">Соц. сети</a></li>
                <li><a href="contacts.html">Контакты</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="container layout">
            <aside class="sidebar">
                <h3>Категории</h3>
                <ul id="category-list">
                    <!-- Категории будут добавлены динамически -->
                </ul>
            </aside>

            <div class="content-area">
                <!-- Секции категорий будут добавлены динамически -->
                <div id="categories-container">
                    <div id="loading" class="loading">Загрузка данных...</div>
                    <!-- Секции будут добавлены здесь -->
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Laser Studio. Все права защищены.</p>
        </div>
    </footer>

    <script type="module">
        console.log("Загружается laserinstall.html с Firestore...");
        // --- Firebase Setup ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAC77MgnqA0LGykek0ffVQnXu3rqadDzzo",
          authDomain: "laser-studio-auth.firebaseapp.com",
          projectId: "laser-studio-auth",
          storageBucket: "laser-studio-auth.firebasestorage.app",
          messagingSenderId: "44076997342",
          appId: "1:44076997342:web:599e315951965d8ead804f",
          measurementId: "G-SF36P0Q05Y"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app); // Инициализируем Firestore

        // --- UI Helper Functions ---
        let currentData = null; // Храним текущие данные
        let unsubscribe = null; // Для отписки от snapshot

        function renderCategories(data) {
            console.log("Рендерим категории из Firestore:", data);
            const categoryList = document.getElementById('category-list');
            const container = document.getElementById('categories-container');
            const loadingDiv = document.getElementById('loading');

            if (!data) {
                 console.error("Данные не загружены!");
                 loadingDiv.textContent = "Ошибка загрузки данных.";
                 return;
            }

            categoryList.innerHTML = '';
            container.innerHTML = '';

            data.categories.forEach(category => {
                // Создаём элемент списка категории
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `#${category.id}`;
                a.textContent = category.name;
                a.onclick = (e) => {
                    e.preventDefault();
                    showCategory(category.id);
                };
                li.appendChild(a);
                categoryList.appendChild(li);

                // Создаём секцию для категории
                const section = document.createElement('div');
                section.id = `category-${category.id}`;
                section.className = 'category-section';
                section.innerHTML = `<h2>${category.name}</h2>`;
                data.items
                    .filter(item => item.category === category.id)
                    .forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'item-card';
                        card.innerHTML = `
                            <div class="item-info">
                                <h3>${item.name}</h3>
                                <p>${item.description}</p>
                            </div>
                            <a href="${item.downloadUrl}" class="download-btn" target="_blank">Скачать</a>
                        `;
                        section.appendChild(card);
                    });
                container.appendChild(section);
            });

            // Показываем первую категорию по умолчанию, если есть данные
            if (data.categories.length > 0 && !document.querySelector('.category-section.active')) {
                showCategory(data.categories[0].id);
            }
            loadingDiv.style.display = 'none'; // Скрываем загрузку
        }

        function showCategory(categoryId) {
            // Скрываем все секции
            document.querySelectorAll('.category-section').forEach(section => {
                section.classList.remove('active');
            });
            // Убираем активный класс с ссылок
            document.querySelectorAll('#category-list a').forEach(link => {
                link.classList.remove('active');
            });

            // Показываем нужную секцию
            document.getElementById(`category-${categoryId}`).classList.add('active');
            // Добавляем активный класс к ссылке
            document.querySelector(`#category-list a[href="#${categoryId}"]`).classList.add('active');
        }

        // --- Firestore Data Loading ---
        async function loadDataFromFirestore() {
            console.log("Запрашиваем данные из Firestore...");
            const docRef = doc(db, "laserInstallData", "config");
            try {
                // Используем onSnapshot для получения обновлений в реальном времени
                if (unsubscribe) {
                    unsubscribe(); // Отписываемся от старого слушателя
                }
                unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        console.log("Данные Firestore получены:", docSnap.data());
                        currentData = docSnap.data();
                        renderCategories(currentData);
                    } else {
                        console.log("Документ не найден в Firestore.");
                        // Можно установить пустые данные или сообщение
                        currentData = { categories: [], items: [] };
                        renderCategories(currentData);
                    }
                }, (error) => {
                    console.error("Ошибка при получении данных из Firestore:", error);
                    document.getElementById('loading').textContent = "Ошибка загрузки данных: " + error.message;
                });
            } catch (error) {
                console.error("Ошибка при запросе к Firestore:", error);
                document.getElementById('loading').textContent = "Ошибка загрузки данных: " + error.message;
            }
        }

        // --- Обработчики событий ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM загружен, инициализируем слушатель Firestore...");
            loadDataFromFirestore(); // Загружаем данные из Firestore при загрузке

            // Проверяем статус авторизации
            onAuthStateChanged(auth, (user) => {
              if (user) {
                console.log("Пользователь вошёл:", user);
                const authStatusDiv = document.getElementById('auth-status');
                authStatusDiv.innerHTML = `
                    <span>Привет, ${user.email || user.phoneNumber || 'Пользователь'}!</span>
                    <button class="logout-btn" onclick="logout()">Выйти</button>
                    ${user.email === 'teevich@mail.ru' ? '<button class="admin-btn" onclick="goToAdmin()">Админ-панель</button>' : ''}
                `;
              } else {
                console.log("Пользователь не вошёл, перенаправление...");
                window.location.href = '/auth.html';
              }
            });
        });

        // Функция выхода
        window.logout = function() {
             signOut(auth).then(() => {
                 console.log("Выход выполнен");
                 window.location.href = '/auth.html';
             }).catch((error) => {
                 console.error("Ошибка выхода:", error);
                 alert("Ошибка при выходе: " + error.message);
             });
        };

        // Функция перехода в админ-панель
        window.goToAdmin = function() {
             window.location.href = '/laserinstalladmin.html';
        };
    </script>
</body>
</html>